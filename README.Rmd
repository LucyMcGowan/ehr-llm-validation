---
title: "On Using Large Language Models to Enhance Clinically-Driven Missing Data Recovery Algorithms in Electronic Health Records"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE, cache = TRUE)
```

## `R` code to accompany the manuscript by [Lotspeich et al. (2025+)](https://arxiv.org/abs/). 

This code relies on the following `R` packages available from CRAN.

  1.  [`ellmer`](https://ellmer.tidyverse.org/): to call large language models (LLM)
  2.  [`dplyr`](https://dplyr.tidyverse.org/): to manipulate data and merge 
  3.  [`stringr`](https://stringr.tidyverse.org/): to clean up strings for merging
  4.  [`tidyr`](https://tidyr.tidyverse.org/): to split strings and reformat roadmaps

```{r, eval = TRUE, message = FALSE}
# Load libraries (install if needed)
library(ellmer)
library(dplyr)
library(stringr)
library(tidyr)
```

## LLM Enhancements 
### LLM (Baseline) Roadmap Without Context

First, we provided the roadmap's structure as a dataframe "tool" that the LLM could access and modify when prompted. Specifically, we created a function that takes search terms for the ALI components (as vectors) and combines them following the clinical roadmap's structure (a $10 \times 2$ dataframe with a rows per component and a column for search terms). 

```{r}
# Initialize a chat with Google Gemini
c <- chat_google_gemini()

# Define a function that takes in vectors of search terms for each component and an output name
## and structures them into a 10 x 2 dataframe 
make_data <- function(creat_c, alb, bmi, sbp, dbp, a1c, chol, trig, crp, hcst, df_name) {
  df <- data.frame(
    Variable_Name = c("CREAT_C", "ALB", "BMI", "BP_SYSTOLIC", "BP_DIASTOLIC", "A1C", "CHOL", "TRIG", "CRP", "HCST"),
    If_Missing_Search_For = c(creat_c, alb, bmi, sbp, dbp, a1c, chol, trig, crp, hcst))
  assign(df_name, df, envir = .GlobalEnv)
}
```

Next, we defined a tool that built on this function by adding a description of the tool's purpose, `"Create a dataframe with text ICD description search terms separated by ; for ICD descriptions to match diagnoses when missing from chart review,"` and arguments for each component of the roadmap framework, like `"Search terms for ICD text descriptions to detect diagnoses that would suggest that a patient's creatinine clearance is at an unhealthy (low) level, separated by a semicolon."`

```{r}
# Convert make_data function into a "tool" to be called by the LLM 
tool_data <- tool(
  make_data,
  description = "Create a data frame with text ICD Description search terms separated by ; for ICD descriptions to match diagnoses when missing from chart review",
  arguments = list(
    creat_c = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's creatinine clearance is at an unhealthy (low) level, separated by a semicolon."),
    alb = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's serum albumin is at an unhealthy (high) level, separated by a semicolon."),
    bmi = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's body mass index (BMI) is at an unhealthy (high) level, separated by a semicolon."),
    sbp = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's systolic blood pressure is at an unhealthy (high) level, separated by a semicolon."),
    dbp = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's diastolic blood pressure is at an unhealthy (high) level, separated by a semicolon."),
    a1c = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's hemoglobin A1c (HbA1c) is at an unhealthy (high) level, separated by a semicolon."),
    chol = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's total cholesterol is at an unhealthy (high) level, separated by a semicolon."),
    trig = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's trigylcerides is at an unhealthy (high) level, separated by a semicolon."),
    crp = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's C-reactive protein is at an unhealthy (high) level, separated by a semicolon."),
    hcst = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's homocysteine is at an unhealthy (high) level, separated by a semicolon."),
    df_name = type_string("Name of the data frame")
  )
)
```

Then, through the `ellmer` package's tool functionality, we registered this tool (i.e., gave Gemini access to use it) and prompted the LLM to generate relevant terms for each ALI component. 

```{r}
# Register tool_data for the Google Gemini chat initialized above
c$register_tool(tool_data)
```

Finally, we essentially requested updates to this roadmap dataframe from the LLM, which `ellmer` executed within our `R` session based on either Prompt 1 or 2 from the main text. In this way, we obtained a programmatically-updated roadmap object that could be immediately used in our missing data recovery algorithm pipeline. 

```{r}
# Prompt the chat, with the registered tool_data
c$chat(
  "Please propose an exhaustive list of terms (avoiding acronyms) that will be used to search ICD Descriptions to identify each of the missing biomarkers and create a data frame with these codes. I want you to repeat this process 20 times, creating a new data frame each time with each having a unique name starting with `df_nocontext`. Each time you repeat this, be sure to make as exhaustive a list as possible. These lists can vary."
)

# Combine datasets (pulls from environment)
dfs <- paste0("df_nocontext_", 1:20)
df_list <- mget(dfs)
df_nocontext <- bind_rows(df_list, .id = "id")
save(df_nocontext, file = here::here("data-raw/no_context-llm.rda"))
```

### LLM (Context) Roadmap

Building on the same `make_data` function for the roadmap's structure, the LLM prompt was modified slightly to instruct the LLM to include the examples from the clinicians' original roadmap (Table 1 in the paper) in each iteration. The rest of the code proceeds as with **LLM (Baseline)**. 

```{r}
# Initialize a new chat with Google Gemini
c_context <- chat_google_gemini()

# Add examples to descriptions when convert make_data function into a "tool" to be called by the LLM 
tool_data <- tool(
  make_data,
  description = "Create a data frame with text ICD Description search terms separated by ; for ICD descriptions to match diagnoses when missing from chart review",
  arguments = list(
    creat_c = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's creatinine clearance is at an unhealthy (low) level (e.g., renal failure, renal insufficiency, acute kidney injury, and chronic renal failure), separated by a semicolon."),
    alb = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's serum albumin is at an unhealthy (high) level, separated by a semicolon."),
    bmi = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's body mass index (BMI) is at an unhealthy (high) level (e.g., Obesity, morbid obesity, Grade I obesity, Grade II obesity, Grade III obesity), separated by a semicolon."),
    sbp = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's systolic blood pressure is at an unhealthy (high) level (e.g., hypertension), separated by a semicolon."),
    dbp = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's diastolic blood pressure is at an unhealthy (high) level (e.g., hypertension), separated by a semicolon."),
    a1c = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's hemoglobin A1c (HbA1c) is at an unhealthy (high) level (e.g., diabetes, impaired glycemic control), separated by a semicolon."),
    chol = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's total cholesterol is at an unhealthy (high) level (e.g., hypercholesterolemia), separated by a semicolon."),
    trig = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's trigylcerides is at an unhealthy (high) level (e.g., hypertriglyceridemia), separated by a semicolon."),
    crp = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's C-reactive protein is at an unhealthy (high) level (e.g., sepsis, infection, autoimmune inflammatory syndrome), separated by a semicolon."),
    hcst = type_string("Search terms for ICD Text Descriptions to detect diagnoses that would suggest that a patient's homocysteine is at an unhealthy (high) level (e.g., hyperhomocysteinemia, vitamin deficiency), separated by a semicolon."),
    df_name = type_string("Name of the data frame")
  )
)

c_context$register_tool(tool_data)
c_context$chat(
  "Please propose an exhaustive list of terms (avoiding acronyms) that will be used to search ICD Descriptions to identify each of the missing biomarkers and create a data frame with these codes. I want you to repeat this process 20 times, creating a new data frame each time with each having a unique name starting with `df_context`. Each time you repeat this, be sure to include the examples given in (e.g.,) and make as exhaustive a list as possible. These lists can vary."
)

dfs <- paste0("df_context_", 1:20)
df_list <- mget(dfs)
df_context <- bind_rows(df_list, .id = "id")
save(df_context, file = here::here("data-raw/context-llm.rda"))
```

## Merging ICD-10 Codes + Roadmaps

We begin by reading in the ICD-10 codes with their diagnosis descriptions, which are archived on this GitHub. Then, we do minor string cleaning on the diagnosis descriptions (making them all capital letters and trimming potential whitespace) to make matching easier. 

```{r, eval = TRUE}
# Read in ICD-10 codes with CDC descriptions (archived on GitHub)
icd10 = read.csv(file = "https://raw.githubusercontent.com/LucyMcGowan/ehr-llm-validation/refs/heads/main/data-raw/icd10cm-codes-2026.csv") |>
  mutate(
    DX_DESC = toupper(x = DX_DESC), ## Convert descriptions to all CAPS for easier search
    DX_DESC = str_trim(string = DX_DESC) ## Trim whitespace
  ) 

## View 
icd10 |> 
  head()
```

Next, we read in a 10 x 2 dataframe for our chosen roadmap. Here, we demonstrate with the LLM (context) roadmap. After reading it in, we again clean the diagnosis descriptions. 

```{r, eval = TRUE}
# Read in LLM (context) roadmap
roadmap = read.csv(file = "https://raw.githubusercontent.com/LucyMcGowan/ehr-llm-validation/refs/heads/main/data-raw/llm_context_roadmap.csv") 

## View roadmap (original dimensions)
roadmap |> 
  head()

# Transform the roadmap into longer format 
roadmap = roadmap |>
  ## Create separate rows for each variable, keyword combo
  separate_longer_delim(cols = If_Missing_Search_For, 
                        delim = ";") |> 
  mutate(
    ## Convert to all CAPS for easier search
    If_Missing_Search_For = toupper(x = If_Missing_Search_For),  
    ## Trim whitespace
    If_Missing_Search_For = str_trim(string = If_Missing_Search_For), 
    ## Remove punctuation
    If_Missing_Search_For = str_replace_all(string = If_Missing_Search_For,
                                            pattern = "[[:punct:]]", 
                                            replacement = ""), 
    ## Remove whitespce left behind
    If_Missing_Search_For = str_replace_all(string = If_Missing_Search_For,
                                            pattern =  "\\s+", 
                                            replacement = ".*")
  )

## View roadmap (longer)
roadmap |> 
  head()
```

Finally, we create a cross-join between the ICD-10 codes and the long version of the roadmap and check for matches. 

```{r, eval = TRUE}
# Create a crosswalk between ICD-10 codes and the roadmap (longer) and check for matches
matches = icd10 |>
  ## Consider all combinations of ICD-10 codes and roadmap search terms 
  cross_join(roadmap) |> 
  ## Subset to combinations where the ICD-10 code and search terms match
  filter(str_detect(string = DX_DESC, 
                    pattern = regex(If_Missing_Search_For, 
                                    ignore_case = TRUE))) 

## View matches (all)
matches |> 
  head()
```

It's possible that multiple search terms match the same ICD-10 codes, so we then group them and summarize all matches per variable per diagnosis. 

```{r, eval = TRUE}
# Summarize all matching search terms per diagnosis/variable 
matches = matches |>
  ## Group by variable and diagnosis 
  group_by(Variable_Name, DX_CODE, DX_DESC) |>
  ## Combine all matching search terms, separated by semicolons 
  summarise(matched_terms = str_trim(string = paste(If_Missing_Search_For, 
                                                    collapse = "; ")), 
            .groups = "drop")

## View matches (summarized)
matches |> 
  head()
```

Then, we merged the roadmaps into patients' ICD-10 codes extracted from the electronic health records (EHR). 